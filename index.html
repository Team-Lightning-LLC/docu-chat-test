<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Document Chat - Ground Zero Test</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Courier New', monospace;
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 20px;
    font-size: 14px;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  h1 {
    color: #4fc3f7;
    margin-bottom: 20px;
    font-size: 24px;
  }
  .section {
    background: #252526;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .section h2 {
    color: #ffb74d;
    font-size: 16px;
    margin-bottom: 15px;
  }
  button {
    background: #007acc;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 14px;
    margin-right: 10px;
    margin-bottom: 10px;
  }
  button:hover {
    background: #005a9e;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  input, textarea {
    width: 100%;
    background: #1e1e1e;
    border: 1px solid #3e3e42;
    color: #d4d4d4;
    padding: 10px;
    font-family: inherit;
    font-size: 14px;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  .log {
    background: #1e1e1e;
    border: 1px solid #3e3e42;
    padding: 15px;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
    font-size: 12px;
  }
  .log-line {
    margin-bottom: 8px;
    padding: 4px;
    border-left: 3px solid #555;
    padding-left: 8px;
  }
  .log-success { border-left-color: #4caf50; color: #81c784; }
  .log-error { border-left-color: #f44336; color: #e57373; }
  .log-info { border-left-color: #2196f3; color: #64b5f6; }
  .log-api { border-left-color: #ff9800; color: #ffb74d; }
  pre {
    background: #1e1e1e;
    border: 1px solid #3e3e42;
    padding: 15px;
    border-radius: 4px;
    overflow-x: auto;
    font-size: 12px;
  }
  .status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
  }
  .status-pass { background: #4caf50; color: white; }
  .status-fail { background: #f44336; color: white; }
  .status-pending { background: #ff9800; color: white; }
</style>
</head>
<body>

<div class="container">
  <h1>ðŸ”¬ Document Chat - Ground Zero Test</h1>
  
  <!-- Step 1: Config -->
  <div class="section">
    <h2>Step 1: Configuration</h2>
    <label>API Key:</label>
    <input type="password" id="apiKey" placeholder="paste-your-api-key-here">
    <label>Environment ID:</label>
    <input type="text" id="envId" placeholder="your-environment-id">
    <button onclick="saveConfig()">Save Config</button>
    <div id="configStatus"></div>
  </div>

  <!-- Step 2: Test Connection -->
  <div class="section">
    <h2>Step 2: Test API Connection</h2>
    <button onclick="testConnection()" id="testBtn" disabled>Test Connection</button>
    <div id="connectionResult"></div>
  </div>

  <!-- Step 3: Load Documents -->
  <div class="section">
    <h2>Step 3: Load One Document</h2>
    <button onclick="loadDocuments()" id="loadBtn" disabled>Load Documents</button>
    <div id="documentsResult"></div>
  </div>

  <!-- Step 4: Execute Interaction -->
  <div class="section">
    <h2>Step 4: Execute DocumentChat</h2>
    <label>Document ID (auto-filled from step 3):</label>
    <input type="text" id="docId" placeholder="will-be-filled-automatically">
    <label>Question:</label>
    <textarea id="question" rows="3" placeholder="what is this document about?"></textarea>
    <button onclick="executeChat()" id="executeBtn" disabled>Execute Chat</button>
    <div id="executionResult"></div>
  </div>

  <!-- Console Log -->
  <div class="section">
    <h2>Console Log</h2>
    <button onclick="clearLog()">Clear Log</button>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
// ============================================================================
// STATE
// ============================================================================
let CONFIG = {
  apiKey: null,
  envId: null,
  baseURL: 'https://api.vertesia.io/api/v1'
};

let STATE = {
  connectionTested: false,
  documentsLoaded: false,
  selectedDocId: null
};

// ============================================================================
// LOGGING
// ============================================================================
function log(message, type = 'info') {
  const logDiv = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  const line = document.createElement('div');
  line.className = `log-line log-${type}`;
  line.textContent = `[${time}] ${message}`;
  logDiv.appendChild(line);
  logDiv.scrollTop = logDiv.scrollHeight;
  console.log(`[${type.toUpperCase()}]`, message);
}

function logJSON(label, data) {
  log(`${label}:`, 'api');
  console.log(data);
  const logDiv = document.getElementById('log');
  const pre = document.createElement('pre');
  pre.textContent = JSON.stringify(data, null, 2);
  pre.style.marginLeft = '20px';
  pre.style.fontSize = '11px';
  logDiv.appendChild(pre);
  logDiv.scrollTop = logDiv.scrollHeight;
}

function clearLog() {
  document.getElementById('log').innerHTML = '';
  log('Log cleared', 'info');
}

// ============================================================================
// STEP 1: SAVE CONFIG
// ============================================================================
function saveConfig() {
  const apiKey = document.getElementById('apiKey').value.trim();
  const envId = document.getElementById('envId').value.trim();
  
  if (!apiKey || !envId) {
    document.getElementById('configStatus').innerHTML = 
      '<span class="status status-fail">Please fill in both fields</span>';
    return;
  }
  
  CONFIG.apiKey = apiKey;
  CONFIG.envId = envId;
  
  document.getElementById('configStatus').innerHTML = 
    '<span class="status status-pass">âœ“ Config saved</span>';
  document.getElementById('testBtn').disabled = false;
  
  log('Configuration saved', 'success');
  log(`Environment ID: ${envId}`, 'info');
}

// ============================================================================
// STEP 2: TEST CONNECTION
// ============================================================================
async function testConnection() {
  log('Testing API connection...', 'info');
  document.getElementById('connectionResult').innerHTML = '<p>Testing...</p>';
  
  try {
    const response = await fetch(`${CONFIG.baseURL}/objects?limit=1`, {
      headers: {
        'Authorization': `Bearer ${CONFIG.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
    
    log(`Response status: ${response.status}`, 'api');
    
    if (!response.ok) {
      const errorText = await response.text();
      log(`Error: ${errorText}`, 'error');
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    logJSON('Connection test response', data);
    
    document.getElementById('connectionResult').innerHTML = 
      '<span class="status status-pass">âœ“ API Connection Working</span>';
    
    STATE.connectionTested = true;
    document.getElementById('loadBtn').disabled = false;
    
    log('Connection test PASSED', 'success');
    
  } catch (error) {
    log(`Connection test FAILED: ${error.message}`, 'error');
    document.getElementById('connectionResult').innerHTML = 
      `<span class="status status-fail">âœ— Connection Failed: ${error.message}</span>`;
  }
}

// ============================================================================
// STEP 3: LOAD DOCUMENTS
// ============================================================================
async function loadDocuments() {
  log('Loading documents...', 'info');
  document.getElementById('documentsResult').innerHTML = '<p>Loading...</p>';
  
  try {
    const response = await fetch(`${CONFIG.baseURL}/objects?limit=10`, {
      headers: {
        'Authorization': `Bearer ${CONFIG.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    logJSON('Documents response', data);
    
    // Find documents array
    let docs = null;
    if (data.objects) docs = data.objects;
    else if (data.data) docs = data.data;
    else if (Array.isArray(data)) docs = data;
    
    if (!docs || docs.length === 0) {
      document.getElementById('documentsResult').innerHTML = 
        '<span class="status status-fail">No documents found</span>';
      log('No documents in response', 'error');
      return;
    }
    
    log(`Found ${docs.length} documents`, 'success');
    
    // Use first document
    const firstDoc = docs[0];
    STATE.selectedDocId = firstDoc.id;
    
    logJSON('Selected document', firstDoc);
    
    document.getElementById('docId').value = firstDoc.id;
    document.getElementById('documentsResult').innerHTML = `
      <span class="status status-pass">âœ“ Loaded ${docs.length} documents</span>
      <p style="margin-top: 10px;">Selected: <strong>${firstDoc.name || 'Untitled'}</strong></p>
      <p style="font-size: 12px; color: #888;">ID: ${firstDoc.id}</p>
    `;
    
    STATE.documentsLoaded = true;
    document.getElementById('executeBtn').disabled = false;
    
    log('Documents loaded successfully', 'success');
    
  } catch (error) {
    log(`Failed to load documents: ${error.message}`, 'error');
    document.getElementById('documentsResult').innerHTML = 
      `<span class="status status-fail">âœ— Failed: ${error.message}</span>`;
  }
}

// ============================================================================
// STEP 4: EXECUTE CHAT
// ============================================================================
async function executeChat() {
  const docId = document.getElementById('docId').value.trim();
  const question = document.getElementById('question').value.trim();
  
  if (!docId || !question) {
    log('Missing document ID or question', 'error');
    return;
  }
  
  log('Executing DocumentChat...', 'info');
  log(`Document: ${docId}`, 'info');
  log(`Question: ${question}`, 'info');
  
  document.getElementById('executionResult').innerHTML = '<p>Executing...</p>';
  document.getElementById('executeBtn').disabled = true;
  
  try {
    const payload = {
      interaction: 'DocumentChat',
      data: {
        task: `Document ID: ${docId}\n\nQuestion: ${question}`
      },
      config: {
        environment: CONFIG.envId,
        model: 'claude-sonnet-4-5-20250929'
      }
    };
    
    logJSON('Request payload', payload);
    
    const response = await fetch(`${CONFIG.baseURL}/execute`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${CONFIG.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    
    log(`Response status: ${response.status}`, 'api');
    
    if (!response.ok) {
      const errorText = await response.text();
      log(`Error response: ${errorText}`, 'error');
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    const data = await response.json();
    logJSON('Execution response', data);
    
    // Try to extract result
    let result = null;
    if (data.result) {
      result = data.result;
      log('Found result in response', 'success');
    } else {
      log('No result field in response', 'error');
    }
    
    document.getElementById('executionResult').innerHTML = `
      <span class="status status-pass">âœ“ Execution Complete</span>
      <h3 style="margin-top: 15px; color: #4fc3f7;">Result:</h3>
      <pre>${JSON.stringify(result || data, null, 2)}</pre>
    `;
    
    log('Execution completed', 'success');
    
  } catch (error) {
    log(`Execution FAILED: ${error.message}`, 'error');
    document.getElementById('executionResult').innerHTML = 
      `<span class="status status-fail">âœ— Failed: ${error.message}</span>`;
  } finally {
    document.getElementById('executeBtn').disabled = false;
  }
}

// ============================================================================
// INIT
// ============================================================================
log('Test playground loaded', 'info');
log('Follow the steps in order: 1 â†’ 2 â†’ 3 â†’ 4', 'info');
</script>

</body>
</html>
