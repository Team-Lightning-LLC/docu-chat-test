<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Document Chat Test Playground</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f5f5f5;
    padding: 20px;
  }
  .container {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
  }
  .panel {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  h1 {
    font-size: 24px;
    margin-bottom: 20px;
    color: #333;
  }
  h2 {
    font-size: 18px;
    margin-bottom: 15px;
    color: #666;
  }
  .doc-list {
    max-height: 600px;
    overflow-y: auto;
  }
  .doc-item {
    padding: 12px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border-radius: 4px;
    cursor: pointer;
    border: 2px solid transparent;
  }
  .doc-item:hover {
    background: #e9ecef;
  }
  .doc-item.active {
    border-color: #007bff;
    background: #e7f3ff;
  }
  .doc-name {
    font-weight: 600;
    margin-bottom: 4px;
  }
  .doc-id {
    font-size: 12px;
    color: #666;
    font-family: monospace;
  }
  .chat-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .selected-doc {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
  }
  .input-section {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
  }
  button {
    padding: 12px 24px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }
  button:hover {
    background: #0056b3;
  }
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .log-section {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 15px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    max-height: 400px;
    overflow-y: auto;
  }
  .log-entry {
    margin-bottom: 8px;
    padding: 4px 0;
    border-bottom: 1px solid #333;
  }
  .log-time {
    color: #888;
  }
  .log-type-info { color: #4fc3f7; }
  .log-type-success { color: #81c784; }
  .log-type-error { color: #e57373; }
  .log-type-api { color: #ffb74d; }
  .log-type-stream { color: #ba68c8; }
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .response-section {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 4px solid #28a745;
  }
  .error-section {
    padding: 15px;
    background: #fff5f5;
    border-radius: 4px;
    border-left: 4px solid #dc3545;
    color: #721c24;
  }
  .stream-section {
    padding: 15px;
    background: #f0f4ff;
    border-radius: 4px;
    border-left: 4px solid #007bff;
  }
  .stream-message {
    padding: 8px;
    margin-bottom: 8px;
    background: white;
    border-radius: 4px;
    font-size: 14px;
    line-height: 1.5;
  }
</style>
</head>
<body>

<div class="container">
  <!-- Left: Document List -->
  <div class="panel">
    <h1>Documents</h1>
    <button onclick="loadDocuments()" style="width: 100%; margin-bottom: 15px;">Load Documents</button>
    <div class="doc-list" id="docList">
      <p style="color: #999;">Click "Load Documents" to begin</p>
    </div>
  </div>

  <!-- Right: Chat Interface -->
  <div class="panel">
    <h1>Document Chat Test</h1>
    
    <div class="chat-section">
      <!-- Selected Document -->
      <div>
        <h2>Selected Document</h2>
        <div class="selected-doc" id="selectedDoc">
          <p style="color: #999;">Select a document from the left</p>
        </div>
      </div>

      <!-- Question Input -->
      <div class="input-section">
        <h2>Ask Question</h2>
        <textarea 
          id="questionInput" 
          rows="3" 
          placeholder="Type your question here..."
          disabled></textarea>
        <button id="sendBtn" onclick="sendQuestion()" disabled>Send Question</button>
      </div>

      <!-- Response -->
      <div id="responseArea"></div>

      <!-- Console Log -->
      <div>
        <h2>Console Log</h2>
        <div class="log-section" id="consoleLog">
          <div class="log-entry">
            <span class="log-time">[00:00:00]</span>
            <span class="log-type-info">READY</span> - Playground initialized
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================================
// CONFIG - PUT YOUR API CREDENTIALS HERE
// ============================================================================
const CONFIG = {
  VERTESIA_API_BASE: 'https://api.vertesia.io/api/v1',
  VERTESIA_API_KEY: 'sk-2538a58567e4ebb6654c0a17ceab228c',
  ENVIRONMENT_ID: '681915c6a01fb262a410c161'
};

// ============================================================================
// STATE
// ============================================================================
let selectedDocument = null;
let documents = [];

// ============================================================================
// LOGGING
// ============================================================================
function log(message, type = 'info') {
  const logDiv = document.getElementById('consoleLog');
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML = `
    <span class="log-time">[${time}]</span>
    <span class="log-type-${type}">${type.toUpperCase()}</span> - ${message}
  `;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight;
  
  console.log(`[${type.toUpperCase()}]`, message);
}

function logJSON(label, data) {
  log(`${label}: ${JSON.stringify(data, null, 2)}`, 'api');
}

// ============================================================================
// API CALLS
// ============================================================================
async function apiCall(endpoint, options = {}) {
  const url = `${CONFIG.VERTESIA_API_BASE}${endpoint}`;
  
  log(`API CALL: ${options.method || 'GET'} ${endpoint}`, 'api');
  
  try {
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${CONFIG.VERTESIA_API_KEY}`,
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });

    log(`API RESPONSE: ${response.status} ${response.statusText}`, 'api');

    if (!response.ok) {
      const errorText = await response.text();
      log(`API ERROR BODY: ${errorText}`, 'error');
      throw new Error(`API call failed: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();
    logJSON('API RESPONSE DATA', data);
    
    return data;
  } catch (error) {
    log(`API CALL FAILED: ${error.message}`, 'error');
    throw error;
  }
}

// ============================================================================
// STREAMING
// ============================================================================
async function streamWorkflow(workflowId, runId) {
  const since = Date.now() - 1000;
  const url = `${CONFIG.VERTESIA_API_BASE}/workflows/runs/${workflowId}/${runId}/stream?since=${since}&access_token=${CONFIG.VERTESIA_API_KEY}`;
  
  log(`Starting stream: ${url}`, 'stream');
  
  const responseArea = document.getElementById('responseArea');
  responseArea.innerHTML = `
    <div class="stream-section">
      <h3 style="margin-bottom: 10px;">
        <span class="spinner"></span> Streaming Response...
      </h3>
      <div id="streamMessages"></div>
    </div>
  `;
  
  const streamMessages = document.getElementById('streamMessages');
  
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`Stream failed: ${response.status} ${response.statusText}`);
    }
    
    log('Stream connected successfully', 'success');
    
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let messageCount = 0;
    let heartbeatCount = 0;
    
    while (true) {
      const { done, value } = await reader.read();
      
      if (done) {
        log('Stream ended', 'stream');
        responseArea.querySelector('h3').innerHTML = `✓ Stream Complete (${messageCount} messages received)`;
        break;
      }
      
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();
      
      for (const line of lines) {
        if (line.trim() === '') continue;
        
        // SSE heartbeat
        if (line === ':') {
          heartbeatCount++;
          if (heartbeatCount % 10 === 0) {
            log(`Still connected (${heartbeatCount} heartbeats, waiting for messages...)`, 'stream');
          }
          continue;
        }
        
        // SSE retry directive
        if (line.startsWith('retry:')) {
          log(`SSE retry directive: ${line}`, 'stream');
          continue;
        }
        
        // SSE data line - THIS IS WHAT WE WANT
        if (line.startsWith('data: ')) {
          const jsonStr = line.substring(6); // Remove "data: " prefix
          
          try {
            const data = JSON.parse(jsonStr);
            messageCount++;
            
            log(`✓ Stream message #${messageCount} received!`, 'stream');
            logJSON(`Message #${messageCount} data`, data);
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'stream-message';
            
            let content = '';
            if (data.content) {
              content = typeof data.content === 'string' ? data.content : JSON.stringify(data.content, null, 2);
            } else if (data.text) {
              content = data.text;
            } else if (data.message) {
              content = data.message;
            } else {
              content = JSON.stringify(data, null, 2);
            }
            
            msgDiv.innerHTML = `
              <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Message #${messageCount}</div>
              <pre style="white-space: pre-wrap; font-size: 12px; margin: 0;">${content}</pre>
            `;
            
            streamMessages.appendChild(msgDiv);
            streamMessages.scrollTop = streamMessages.scrollHeight;
            
            if (data.type === 'complete' || data.status === 'completed') {
              log('Completion signal received', 'success');
              responseArea.querySelector('h3').innerHTML = `✓ Stream Complete (${messageCount} messages)`;
              return;
            }
            
          } catch (e) {
            log(`Failed to parse SSE data: ${e.message}`, 'error');
            log(`Raw data line: ${jsonStr}`, 'error');
          }
        }
      }
    }
    
    if (messageCount === 0) {
      log('⚠️ Stream ended but NO MESSAGES received - only heartbeats', 'error');
      responseArea.innerHTML = `
        <div class="error-section">
          <h3 style="margin-bottom: 10px;">No Messages Received</h3>
          <p>The stream connected successfully but the DocumentChat interaction did not send any messages.</p>
          <p style="margin-top: 10px;">This usually means:</p>
          <ul style="margin-left: 20px; margin-top: 5px;">
            <li>The interaction is running but not configured to output to the stream</li>
            <li>The interaction failed silently</li>
            <li>The interaction needs different input format</li>
          </ul>
          <p style="margin-top: 10px;">Check the Vertesia UI to see if the run completed and what the output was.</p>
        </div>
      `;
    }
    
  } catch (error) {
    log(`Streaming error: ${error.message}`, 'error');
    responseArea.innerHTML = `
      <div class="error-section">
        <h3 style="margin-bottom: 10px;">Streaming Error</h3>
        <p>${error.message}</p>
      </div>
    `;
  }
}

// ============================================================================
// LOAD DOCUMENTS
// ============================================================================
async function loadDocuments() {
  log('Loading documents from Vertesia...', 'info');
  
  const docList = document.getElementById('docList');
  docList.innerHTML = '<p style="color: #999;">Loading...</p>';
  
  try {
    const response = await apiCall('/objects?limit=100&offset=0');
    
    log('Checking response structure...', 'info');
    log(`Response keys: ${Object.keys(response).join(', ')}`, 'info');
    
    let docArray = null;
    
    if (response.objects) {
      docArray = response.objects;
      log('Found documents in response.objects', 'info');
    } else if (response.data) {
      docArray = response.data;
      log('Found documents in response.data', 'info');
    } else if (Array.isArray(response)) {
      docArray = response;
      log('Response itself is an array', 'info');
    } else if (response.items) {
      docArray = response.items;
      log('Found documents in response.items', 'info');
    } else {
      log('Unknown response structure - dumping full response', 'error');
      logJSON('Full response', response);
      docList.innerHTML = '<p style="color: #dc3545;">Unknown response format - check console</p>';
      return;
    }
    
    if (!docArray || docArray.length === 0) {
      docList.innerHTML = '<p style="color: #999;">No documents found</p>';
      log('Document array is empty', 'info');
      return;
    }
    
    documents = docArray;
    log(`Loaded ${documents.length} documents`, 'success');
    
    logJSON('First document structure', documents[0]);
    
    docList.innerHTML = documents.map(doc => `
      <div class="doc-item" onclick="selectDocument('${doc.id}')">
        <div class="doc-name">${doc.name || doc.title || 'Untitled'}</div>
        <div class="doc-id">${doc.id}</div>
      </div>
    `).join('');
    
  } catch (error) {
    docList.innerHTML = '<p style="color: #dc3545;">Failed to load documents</p>';
    log(`Failed to load documents: ${error.message}`, 'error');
  }
}

// ============================================================================
// SELECT DOCUMENT
// ============================================================================
function selectDocument(docId) {
  const doc = documents.find(d => d.id === docId);
  if (!doc) return;
  
  selectedDocument = doc;
  log(`Selected document: ${doc.name} (${doc.id})`, 'info');
  
  document.querySelectorAll('.doc-item').forEach(item => {
    item.classList.remove('active');
  });
  event.target.closest('.doc-item').classList.add('active');
  
  document.getElementById('selectedDoc').innerHTML = `
    <div class="doc-name" style="margin-bottom: 8px;">${doc.name || 'Untitled'}</div>
    <div class="doc-id">${doc.id}</div>
  `;
  
  document.getElementById('questionInput').disabled = false;
  document.getElementById('sendBtn').disabled = false;
}

// ============================================================================
// SEND QUESTION
// ============================================================================
async function sendQuestion() {
  if (!selectedDocument) {
    log('No document selected', 'error');
    return;
  }
  
  const questionInput = document.getElementById('questionInput');
  const question = questionInput.value.trim();
  
  if (!question) {
    log('No question entered', 'error');
    return;
  }
  
  log(`Sending question: "${question}"`, 'info');
  log(`Document ID: ${selectedDocument.id}`, 'info');
  
  questionInput.disabled = true;
  document.getElementById('sendBtn').disabled = true;
  document.getElementById('sendBtn').innerHTML = '<span class="spinner"></span> Sending...';
  
  document.getElementById('responseArea').innerHTML = '';
  
  try {
    const task = `Document ID: ${selectedDocument.id}\n\nQuestion: ${question}`;
    log(`Task prompt: ${task}`, 'info');
    
    const response = await apiCall('/execute/async', {
      method: 'POST',
      body: JSON.stringify({
        type: 'interaction',
        interaction: 'DocumentChat',
        data: {
          Task: task
        },
        config: {
          environment: CONFIG.ENVIRONMENT_ID,
          model: 'claude-sonnet-4-5-20250929'
        }
      })
    });
    
    log('API call successful!', 'success');
    logJSON('Full response object', response);
    
    const runId = response.runId;
    const workflowId = response.workflowId;
    
    if (!runId || !workflowId) {
      log('Missing runId or workflowId - cannot stream', 'error');
      document.getElementById('responseArea').innerHTML = `
        <div class="error-section">
          <h3 style="margin-bottom: 10px;">Error</h3>
          <p>Response missing runId or workflowId</p>
          <pre style="font-size: 12px; margin-top: 10px;">${JSON.stringify(response, null, 2)}</pre>
        </div>
      `;
      return;
    }
    
    log(`Got runId: ${runId}`, 'success');
    log(`Got workflowId: ${workflowId}`, 'success');
    
    // Start streaming
    await streamWorkflow(workflowId, runId);
    
  } catch (error) {
    log(`Failed to send question: ${error.message}`, 'error');
    
    document.getElementById('responseArea').innerHTML = `
      <div class="error-section">
        <h3 style="margin-bottom: 10px;">Error</h3>
        <p>${error.message}</p>
      </div>
    `;
  } finally {
    questionInput.disabled = false;
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('sendBtn').textContent = 'Send Question';
  }
}

// ============================================================================
// INITIALIZE
// ============================================================================
log('Playground loaded. Click "Load Documents" to start.', 'info');
</script>

</body>
</html>
